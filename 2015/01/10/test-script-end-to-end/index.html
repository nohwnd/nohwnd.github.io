
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>jakubjares.com</title>
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato:100,300,400,700,900,900i|Roboto" rel="stylesheet">

    
<link rel="stylesheet" href="/scss/styles.css">

    
<link rel="stylesheet" href="/scss/highlight.css">

    
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-111716940-1', 'auto');
	ga('send', 'pageview');
</script>

<meta name="generator" content="Hexo 7.2.0"></head>

<body>
    <header class="article-header">
    <div class="main-page-header-filler"></div>
    <div class="menu">
        <a href="/">
            <div>
                <svg viewBox="76 -3 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <path d="M80.5814303,71.6096505 C75.6649156,71.5033353 83.1767812,0.439369496 89.9186348,0.439368205 C97.914984,0.439366673 116.442438,74.9999972 125.727143,75 C135.011849,75.0000028 147.86947,0.507256695 151.30356,0.507256695 C154.73765,0.507256695 150.408807,74.9427912 142.667229,74.9427906 C134.925651,74.94279 120.545497,1.52077528e-08 106.655055,-7.10542736e-15 C94.9311609,-1.28357508e-08 85.497945,71.7159657 80.5814303,71.6096505 Z"
        id="Path-7" stroke="#FFFFFF" stroke-width="4" stroke-linecap="square" fill="none"></path>
</svg>
                <h1>Jakub<br />Jareš</h1>
            </div>
        </a>
        <nav>
            
            <a href="/">
                talks</a>
            
            <a href="/articles">
                articles</a>
            
            <a href="/about">
                about</a>
            
        </nav>
    </div>
    <div class="title">
        <h1>
            Test PowerShell Scripts End-to-end With Pester
        </h1>
        <div>
            
            <a href="/tags/powershell/">
                <p>powershell</p>
            </a>
            
            <a href="/tags/pester/">
                <p>pester</p>
            </a>
            
            <a href="/tags/testing/">
                <p>testing</p>
            </a>
            
        </div>
    </div>
</header>

<div class="article">

    <div class="article-content">
        <h2 id="End-to-end-test-of-simple-script"><a href="#End-to-end-test-of-simple-script" class="headerlink" title="End-to-end test of simple script"></a>End-to-end test of simple script</h2><p>With Pester it is really easy to test a single PowerShell function or a library of them, but what if your script contains some code that runs those functions?</p>
<p>Let’s say we have a script like this one:</p>
<span id="more"></span>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># file GetSomethingScript.ps1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-Something</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;something&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Something</span></span><br></pre></td></tr></table></figure>

<!-- more -->

<p>This script defines a function and then calls it. This is pretty normal approach if you want your script to actually do something, instead of being just a library of functions.</p>
<p>But see what happens if we decide to test this script using Pester:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line">. <span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1</span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;Get-Something&#x27;</span> &#123;</span><br><span class="line">  It <span class="string">&#x27;Gets something&#x27;</span> &#123;</span><br><span class="line">      <span class="built_in">Get-Something</span> | Should Be <span class="string">&#x27;something&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And run the test code:</p>
<img src="/2015/01/10/test-script-end-to-end/runtwice.png" class="">

<p>As you can see the <code>Get-Something</code> function was run before running the tests as well. This is because we are dot-sourcing the tested script which means running it in the current scope (Using Dot Source Notation with Scope.). This is not good because the script should not run at this time.</p>
<p>So we need a way to dot source the script without running the <code>Get-Something</code> function. To do that we check the value of <code>$MyInvocation.InvocationName</code> as such:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-Something</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;something&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$MyInvocation</span>.InvocationName <span class="operator">-ne</span> <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Get-Something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That condition makes sure the script imports properly when dot sourced, and that it runs properly when invoked by the user from PowerShell console or PowerShell ISE.</p>
<p>Now you might be tempted to check if that worked with tests that go like this:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="variable">$scriptPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1&quot;</span></span><br><span class="line">. <span class="variable">$scriptPath</span></span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;Get-Something&#x27;</span> &#123;</span><br><span class="line">  It <span class="string">&#x27;Gets something&#x27;</span> &#123;</span><br><span class="line">        <span class="built_in">Get-Something</span> | Should Be <span class="string">&#x27;something&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;GetSomethingScript.ps1&#x27;</span> &#123;</span><br><span class="line">    Mock <span class="built_in">Get-Something</span> &#123;&#125;</span><br><span class="line">    It <span class="string">&#x27;Runs the entry point function when invoked normally&#x27;</span> &#123;</span><br><span class="line">        &amp;<span class="variable">$scriptPath</span> | Should Be  <span class="string">&#x27;something&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    It <span class="string">&#x27;Does not run the entry point function when dot sourced&#x27;</span> &#123;</span><br><span class="line">        . <span class="variable">$scriptPath</span></span><br><span class="line">        <span class="built_in">Assert-MockCalled</span> <span class="built_in">Get-Something</span> <span class="literal">-Exactly</span> <span class="number">0</span> <span class="literal">-Scope</span> It</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And on the first look it might seem to work correctly, but the second test is not proving anything. Dot sourcing the script inside the <code>It</code> block <strong>redefines</strong> the <code>Get-Something</code> function which makes it invisible for Mocking. So even if the function was called hundred times you’d still get green result. Checking for 0 calls with Mocking is always tricky.</p>
<p>Let’s prove that I am right by calling the <code>Get-Something</code> function before <code>Assert-MockCalled</code> which should make the <code>It</code> fail. We also save the result, which should be empty as defined by the Mock, and check that as well.</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="variable">$scriptPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1&quot;</span></span><br><span class="line">. <span class="variable">$scriptPath</span></span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;Get-Something&#x27;</span> &#123;</span><br><span class="line">  It <span class="string">&#x27;Gets something&#x27;</span> &#123;</span><br><span class="line">        <span class="built_in">Get-Something</span> | Should Be <span class="string">&#x27;something&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;GetSomethingScript.ps1&#x27;</span> &#123;</span><br><span class="line">    Mock <span class="built_in">Get-Something</span> &#123;&#125;</span><br><span class="line">    It <span class="string">&#x27;Runs the entry point function when invoked normally&#x27;</span> &#123;</span><br><span class="line">        &amp;<span class="variable">$scriptPath</span> | Should Be  <span class="string">&#x27;something&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    It <span class="string">&#x27;Does not run the entry point function when dot sourced&#x27;</span> &#123;</span><br><span class="line">        . <span class="variable">$scriptPath</span></span><br><span class="line">        <span class="comment">#call the function before mock and save the result</span></span><br><span class="line">        <span class="variable">$result</span> = <span class="built_in">Get-Something</span></span><br><span class="line">        <span class="built_in">Assert-MockCalled</span> <span class="built_in">Get-Something</span> <span class="literal">-Exactly</span> <span class="number">0</span> <span class="literal">-Scope</span> It</span><br><span class="line">        <span class="variable">$result</span> | Should BeNullOrEmpty</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This puts us in a weird situation, we have code in our script that we are unable to test. Unfortunately there is no simple solution for this at the moment.</p>
<h2 id="How-about-more-complicated-scripts"><a href="#How-about-more-complicated-scripts" class="headerlink" title="How about more complicated scripts?"></a>How about more complicated scripts?</h2><p>Another problem you might face is that you want to check if the entry-point function of your script is run, but you don’t want to run the whole script to do that. The reason might simply be that the script takes too long to run.</p>
<p>Your knee-jerk reaction to this might be writing a test like this one:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="variable">$scriptPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1&quot;</span></span><br><span class="line">. <span class="variable">$scriptPath</span></span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;GetSomethingScript.ps1&#x27;</span> &#123;</span><br><span class="line">    Mock <span class="built_in">Get-Something</span> &#123;&#125;</span><br><span class="line">    It <span class="string">&#x27;Runs the entry point function when invoked normally&#x27;</span> &#123;</span><br><span class="line">        &amp;<span class="variable">$scriptPath</span></span><br><span class="line">        <span class="built_in">Assert-MockCalled</span> <span class="built_in">Get-Something</span> <span class="literal">-Exactly</span> <span class="number">1</span> <span class="literal">-Scope</span> It</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But unfortunately that won’t work because invoking the script with &amp; starts it in another scope where, Mocking can’t see it.</p>
<p>To run it in the current scope you could use dot sourcing, but as we learned earlier dot sourcing the script inside the It block redefines the Get-Something function which makes it invisible for Mocking. Not to mention you now have to find a different mechanism to solve the first (dot sourcing the script to Pester) problem.</p>
<p>Unfortunately there is no elegant way around it at the moment so the low-tech and frankly horrible solution I use is regexing the last lines of the script:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="variable">$scriptPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1&quot;</span></span><br><span class="line">. <span class="variable">$scriptPath</span></span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;GetSomethingScript.ps1&#x27;</span> &#123;</span><br><span class="line">    Mock <span class="built_in">Get-Something</span> &#123;&#125;</span><br><span class="line">    It <span class="string">&#x27;Runs the entry point function when invoked normally&#x27;</span> &#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="built_in">Get-Content</span> <span class="literal">-Path</span> <span class="variable">$scriptPath</span> <span class="literal">-Tail</span> <span class="number">4</span> <span class="literal">-ReadCount</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        <span class="operator">-join</span> <span class="variable">$content</span> <span class="operator">-replace</span> <span class="string">&#x27;\s&#x27;</span> |</span><br><span class="line">        Should Match ([<span class="type">regex</span>]::Escape(<span class="string">&#x27;if($MyInvocation.InvocationName-ne&#x27;</span><span class="string">&#x27;.&#x27;</span><span class="string">&#x27;)&#123;Get-Something&#125;&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It gets job done, and actually works pretty well, but a better solution is definitely needed.</p>
<h3 id="Different-approach"><a href="#Different-approach" class="headerlink" title="Different approach"></a>Different approach</h3><p>There is also a different approach to the whole problem, that Dave Wyatt suggested when I talked with him about the dot sourcing problem few months ago: Provide a parameter that is used only by Pester.</p>
<p>I don’t like it much because I believe the script should not expose anything test framework specific. But I will use that approach to show what is needed to actually test all those cases properly.</p>
<p>First here is a basic check if the script is being dot sourced, we just add and use the $UnderTest parameter instead of $MyInvocation.InvocationName:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.ps1</span></span><br><span class="line"><span class="keyword">param</span> (</span><br><span class="line">    [<span class="type">switch</span>]<span class="variable">$UnderTest</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-Something</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&#x27;something&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="operator">-not</span> <span class="variable">$UnderTest</span>)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">Get-Something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="variable">$scriptPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1&quot;</span></span><br><span class="line"><span class="comment">#do not forget to set the UnderTest parameter here</span></span><br><span class="line">. <span class="variable">$scriptPath</span> <span class="literal">-UnderTest</span></span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;Get-Something&#x27;</span> &#123;</span><br><span class="line">  It <span class="string">&#x27;Gets something&#x27;</span> &#123;</span><br><span class="line">        <span class="built_in">Get-Something</span> | Should Be <span class="string">&#x27;something&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This again gives you the power to stop the Get-Something from running when dot sourced, but still you can’t test that. And you can’t test if main entry point is run (when the script is invoked normally) either.</p>
<p>What would be actually needed is something like this:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file GetSomethingScript.ps1</span></span><br><span class="line"><span class="keyword">param</span> (</span><br><span class="line">    [<span class="type">switch</span>]<span class="variable">$UnderTest</span>,</span><br><span class="line">    [<span class="type">switch</span>]<span class="variable">$EntrypointTest</span>,</span><br><span class="line">    [<span class="type">switch</span>]<span class="variable">$DotsourcingTest</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#when dot sourcing is tested do not redifine the Main function</span></span><br><span class="line"><span class="comment">#to keep Mocking work</span></span><br><span class="line"><span class="keyword">if</span> (<span class="operator">-not</span> <span class="variable">$DotsourcingTest</span>) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Main</span></span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">#user defined code</span></span><br><span class="line">        <span class="built_in">Get-Something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#all user defined functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-Something</span></span> &#123;</span><br><span class="line">    <span class="string">&#x27;something&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="operator">-not</span> <span class="variable">$UnderTest</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">#when entrypoint is tested redefine the function to </span></span><br><span class="line">    <span class="comment">#return dummy value</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$EntrypointTest</span>) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">Main</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;___Pester_Test_Value&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Main</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#file GetSomethingScript.Tests.ps1</span></span><br><span class="line"><span class="variable">$scriptPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\GetSomethingScript.ps1&quot;</span></span><br><span class="line">. <span class="variable">$scriptPath</span> <span class="literal">-UnderTest</span></span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;Get-Something&#x27;</span> &#123;</span><br><span class="line">  It <span class="string">&#x27;Gets something&#x27;</span> &#123;</span><br><span class="line">        <span class="built_in">Get-Something</span> | Should Be <span class="string">&#x27;something&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Describe <span class="string">&#x27;GetSomethingScript.ps1&#x27;</span> &#123;</span><br><span class="line">    Mock Main &#123;<span class="string">&#x27;mock&#x27;</span>&#125;</span><br><span class="line">    It <span class="string">&#x27;Runs the entry point function when invoked normally&#x27;</span> &#123;</span><br><span class="line">       &amp;<span class="variable">$scriptPath</span> <span class="literal">-entrypointTest</span> | Should Be <span class="string">&#x27;___Pester_test_value&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    It <span class="string">&#x27;Does not run the entry point function when tested&#x27;</span> &#123;</span><br><span class="line">        . <span class="variable">$scriptPath</span> <span class="literal">-UnderTest</span> <span class="literal">-dotsourcingTest</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Assert-MockCalled</span> Main <span class="literal">-Exactly</span> <span class="number">0</span> <span class="literal">-Scope</span> It</span><br><span class="line">        Main | Should Be <span class="string">&#x27;mock&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#you would not put this in production</span></span><br><span class="line">    <span class="comment">#because that is the problem we are trying to solve</span></span><br><span class="line">    It <span class="string">&#x27;Can actually run normally&#x27;</span> &#123;</span><br><span class="line">       &amp;<span class="variable">$scriptPath</span> | Should Be <span class="string">&#x27;something&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But of course we can’t require Pester users to put all this logic in their scripts. Another way to do this would be to AST the script, make a backup copy of it and inject those definitions in, but I am reluctant to edit the tested script in any way.</p>
<p>BTW: <code>$MyInvocation.InvocationName</code> works flawelessly in ISE and Console, but it does not work in PowerGUI because it dot sources all scripts when running them, so as a result you won’t be able to run your scripts in PowerGUI.</p>

    </div>
    <div class="article-footer">
        <p>written at</p>
        <time datetime="">
            10 January 2015
        </time>
    </div>
</div>
<footer class="footer">
    <div class="footer-filler"></div>

    <a href="https://twitter.com/nohwnd">twitter</a>&bull;
    <a href="https://github.com/nohwnd">github</a>&bull;
    <a href="https://linkedin.com/in/jares/">linkedin</a>
</footer>
</body>

</html>
