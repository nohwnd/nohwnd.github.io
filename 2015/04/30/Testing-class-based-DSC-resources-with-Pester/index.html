
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>jakubjares.com</title>
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato:100,300,400,700,900,900i|Roboto" rel="stylesheet">

    
<link rel="stylesheet" href="/scss/styles.css">

    
<link rel="stylesheet" href="/scss/highlight.css">

    
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-111716940-1', 'auto');
	ga('send', 'pageview');
</script>

<meta name="generator" content="Hexo 7.2.0"></head>

<body>
    <header class="article-header">
    <div class="main-page-header-filler"></div>
    <div class="menu">
        <a href="/">
            <div>
                <svg viewBox="76 -3 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <path d="M80.5814303,71.6096505 C75.6649156,71.5033353 83.1767812,0.439369496 89.9186348,0.439368205 C97.914984,0.439366673 116.442438,74.9999972 125.727143,75 C135.011849,75.0000028 147.86947,0.507256695 151.30356,0.507256695 C154.73765,0.507256695 150.408807,74.9427912 142.667229,74.9427906 C134.925651,74.94279 120.545497,1.52077528e-08 106.655055,-7.10542736e-15 C94.9311609,-1.28357508e-08 85.497945,71.7159657 80.5814303,71.6096505 Z"
        id="Path-7" stroke="#FFFFFF" stroke-width="4" stroke-linecap="square" fill="none"></path>
</svg>
                <h1>Jakub<br />Jareš</h1>
            </div>
        </a>
        <nav>
            
            <a href="/">
                talks</a>
            
            <a href="/articles">
                articles</a>
            
            <a href="/about">
                about</a>
            
        </nav>
    </div>
    <div class="title">
        <h1>
            Testing class based DSC resources with Pester
        </h1>
        <div>
            
            <a href="/tags/powershell/">
                <p>powershell</p>
            </a>
            
            <a href="/tags/pester/">
                <p>pester</p>
            </a>
            
            <a href="/tags/testing/">
                <p>testing</p>
            </a>
            
            <a href="/tags/dsc/">
                <p>dsc</p>
            </a>
            
        </div>
    </div>
</header>

<div class="article">

    <div class="article-content">
        <p><em>I am using PowerShell version 5.0.10018.0 for the examples. This version of PowerShell ships with the WMF February 2015 Preview package that you can download here.</em></p>
<p>I was asked if there are any resources on testing class based DSC resources. And to be honest I am not sure. We shortly discussed the possibilities on the PS MVP mailing list, but I am still not sure what are the possibilities. So why not discover them while learning something more about the topic.</p>
<p>Luckily there are quite a few great resources on how to actually create a class based DSC resource, and what you need to do that. Some of them are:</p>
<p>Creating a Class based DSC Resource using PowerShell</p>
<p>Class-defined DSC resources in Windows Management Framework 5.0 Preview</p>
<p>Writing a custom DSC resource with PowerShell classes</p>
<span id="more"></span>

<h3 id="Writing-the-first-test"><a href="#Writing-the-first-test" class="headerlink" title="Writing the first test"></a>Writing the first test</h3><p>I will be using the example code from the last article to go outside-in with Pester, and to pretend that I am actually writing the code myself.</p>
<p>At the bottom of the Microsoft article you find an example of how the finished resource is used. This example is an ideal candidate for our first integration test. This integration test will describe the basic functionality of the resource</p>
<p>The test looks like this:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Describe <span class="string">&#x27;Test resource&#x27;</span> &#123;</span><br><span class="line">    It <span class="string">&#x27;Adds a file correctly&#x27;</span> &#123;</span><br><span class="line">        <span class="comment"># -- Arrange</span></span><br><span class="line">        Configuration Test</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Import-DSCResource</span> <span class="literal">-module</span> <span class="string">&#x27;MyDscResource&#x27;</span></span><br><span class="line">            FileResource file</span><br><span class="line">            &#123;</span><br><span class="line">                Path = <span class="string">&quot;TestDrive:\test.txt&quot;</span></span><br><span class="line">                Ensure = <span class="string">&quot;Present&quot;</span></span><br><span class="line"></span><br><span class="line">                SourcePath = <span class="string">&quot;TestDrive:\Source\test.txt&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> Directory <span class="literal">-Name</span> Source <span class="literal">-Path</span> TestDrive:\</span><br><span class="line">        <span class="built_in">Set-Content</span> <span class="literal">-Path</span> TestDrive:\Source\test.txt <span class="literal">-Value</span> <span class="string">&quot;some string&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> Directory <span class="literal">-Name</span> Output <span class="literal">-Path</span> TestDrive:\</span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- Act</span></span><br><span class="line">        Test <span class="literal">-OutputPath</span> TestDrive:\Output</span><br><span class="line">        <span class="built_in">Start-DscConfiguration</span> <span class="literal">-Verbose</span> <span class="literal">-Wait</span> TestDrive:\Output</span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- Assert</span></span><br><span class="line">        <span class="string">&quot;TestDrive:\test.txt&quot;</span> | should Exist</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I had to slightly change the code shown in the article, but that’s expected because we are using preview version of the technology. The test has three parts: Arrange, Act and Assert.</p>
<p>In the Arrange part I most importantly define the DSC configuration using the <code>FileResource</code> resource. The configuration defines that: “I desire the file TestDrive:\test.txt to be present”.</p>
<p>The configuration also defines the <code>SourcePath</code>, which is where the original file is placed. For the test I just use the TestDrive to store the file.</p>
<p>I also create all the needed files and folders in the Arrange part of the test.</p>
<p>In the Act phase I start by generating the configuration MOF file by calling it by it’s name: <code>Test</code>. And then continue to exercise the system-under-test (SUT) by actually invoking the DSC configuration.</p>
<p>In the last part, Assert, I check if the desired action was really performed. That is, if the file <code>test.txt</code> is in the root of the <code>TestDrive:\</code>.</p>
<p>This should do for our first test. So let’s run it and see if it fails.</p>
<h3 id="Running-the-first-test"><a href="#Running-the-first-test" class="headerlink" title="Running the first test"></a>Running the first test</h3><p>If you re-call the RED-GREEN-REFACTOR cycle of TDD, you know that now we should let the test run, and make sure it fails (RED). So let’s press F5 to do just that.</p>
<p>And indeed the test fails horribly.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">At C:\Projects\TestFileDscResources\MyDscResources\MyDscResource.Tests.ps1:6 char:13</span><br><span class="line">+             Import-DSCResource -module &#x27;MyDscResource&#x27;</span><br><span class="line">+             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">Unable to load module &#x27;MyDscResource&#x27;: module not found.</span><br><span class="line">At C:\Projects\TestFileDscResources\MyDscResources\MyDscResource.Tests.ps1:7 char:13</span><br><span class="line">+             FileResource file</span><br><span class="line">+             ~~~~~~~~~~~~</span><br><span class="line">Undefined DSC resource &#x27;FileResource&#x27;. Use Import-DSCResource to import the resource.</span><br><span class="line">    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException</span><br><span class="line">    + FullyQualifiedErrorId : ModuleNotFoundDuringParse</span><br></pre></td></tr></table></figure>

<p>If you now assume that we saw the test fail and we can proceed to implement the correct behavior, you should know that this is not the case. The test failed, but it did not fail in the correct way. It must fail in the assertion to count as a proper fail.</p>
<p>To get to the point where the test fails correctly we can just follow the error messages, and oh boy there are many. The first few error messages suggested that there is no <code>FileResource</code> available in the module directory. There were also few Access Denied error messages. And the <code>TestDrive:\</code> also could not be found, because the configuration is done by a Windows service running as the SYSTEM account. I also had problems with remoting not being setup correctly.</p>
<p>So in the end I ended doing this:</p>
<ul>
<li>Placing <code>MyDscResource.psm1</code> and <code>MyDscResource.psd1</code> in <code>C:\Program Files\WindowsPowerShell\Modules\MyDscResource</code> (file contents are listed below)</li>
<li>Setting my public network to private network</li>
<li>Enabling PowerShell remoting by running Enable-PSRemoting -Force</li>
<li>Running the tests AsAdministrator</li>
<li>Using $TestDrive (real path to the temporary folder) instead of the TestDrive PSDrive</li>
</ul>
<p>So the test ended up looking like this:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Describe <span class="string">&#x27;Test resource&#x27;</span> &#123;</span><br><span class="line">    It <span class="string">&#x27;Adds a file correctly&#x27;</span> &#123;</span><br><span class="line">        <span class="comment"># -- Arrange</span></span><br><span class="line">        Configuration Test</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Import-DSCResource</span> <span class="literal">-module</span> <span class="string">&#x27;MyDscResource&#x27;</span></span><br><span class="line">            FileResource file</span><br><span class="line">            &#123;</span><br><span class="line">                Path = <span class="string">&quot;<span class="variable">$testDrive</span>\test.txt&quot;</span></span><br><span class="line">                Ensure = <span class="string">&quot;Present&quot;</span></span><br><span class="line"></span><br><span class="line">                SourcePath = <span class="string">&quot;<span class="variable">$testDrive</span>\Source\test.txt&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> Directory <span class="literal">-Name</span> Source <span class="literal">-Path</span> <span class="variable">$testDrive</span></span><br><span class="line">        <span class="built_in">Set-Content</span> <span class="literal">-Path</span> <span class="string">&quot;<span class="variable">$testDrive</span>\Source\test.txt&quot;</span> <span class="literal">-Value</span> <span class="string">&quot;some string&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> Directory <span class="literal">-Name</span> Output <span class="literal">-Path</span> <span class="variable">$testDrive</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- Act</span></span><br><span class="line">        Test <span class="literal">-OutputPath</span> <span class="string">&quot;<span class="variable">$testDrive</span>\Output&quot;</span></span><br><span class="line">        <span class="built_in">Start-DscConfiguration</span> <span class="literal">-Verbose</span> <span class="literal">-Force</span> <span class="literal">-Wait</span> <span class="string">&quot;<span class="variable">$testDrive</span>\Output&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -- Assert</span></span><br><span class="line">        <span class="string">&quot;<span class="variable">$testDrive</span>\test.txt&quot;</span> | should Exist</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And the resource is implemented like this:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file MyDscResource.psd1</span></span><br><span class="line"><span class="selector-tag">@</span>&#123;</span><br><span class="line">    RootModule = <span class="string">&#x27;MyDscResource.psm1&#x27;</span></span><br><span class="line"></span><br><span class="line">    DscResourcesToExport = <span class="string">&#x27;FileResource&#x27;</span></span><br><span class="line"></span><br><span class="line">    ModuleVersion = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file: MyDscResource.psm1</span></span><br><span class="line">[<span class="type">DscResource</span>()]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileResource</span></span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="type">DscProperty</span>(<span class="type">Key</span>)]</span><br><span class="line">    [<span class="built_in">string</span>]<span class="variable">$Path</span></span><br><span class="line"></span><br><span class="line">    [<span class="type">DscProperty</span>(<span class="type">Mandatory</span>)]</span><br><span class="line">    [<span class="built_in">string</span>]<span class="variable">$SourcePath</span></span><br><span class="line"></span><br><span class="line">    [<span class="type">DscProperty</span>(<span class="type">Mandatory</span>)]</span><br><span class="line">    [<span class="built_in">string</span>] <span class="variable">$Ensure</span> <span class="comment">#not using the Ensure type yet</span></span><br><span class="line"></span><br><span class="line">    <span class="function">[<span class="built_in">bool</span>] <span class="title">Test</span></span>() &#123; <span class="keyword">return</span> <span class="variable">$false</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">[<span class="type">FileResource</span>] <span class="title">Get</span></span>() &#123; <span class="keyword">return</span> <span class="variable">$null</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">[<span class="built_in">void</span>] <span class="title">Set</span></span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Describing Test resource</span><br><span class="line"> [-] Adds a file correctly 454ms</span><br><span class="line">   Expected: &#123;C:\Users\nohwnd\AppData\[...]\test.txt&#125; to exist</span><br><span class="line">   at line: 26 in C:\Users\nohwnd\Desktop\MyDscResource.Tests.ps1</span><br><span class="line">   26:         &quot;$testDrive\test.txt&quot; | should Exist</span><br></pre></td></tr></table></figure>
<p>Uff!</p>
<h3 id="Making-the-first-test-green"><a href="#Making-the-first-test-green" class="headerlink" title="Making the first test green"></a>Making the first test green</h3><p>So now that we have all the infrastructure setup satisfying the test is really simple. All you need to do is to create the <code>$testDrive\test.txt</code> file. So let’s change the <code>Set()</code> method to do that.</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#file: MyDscResource.psm1[DscResource()]</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileResource</span></span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="type">DscProperty</span>(<span class="type">Key</span>)]</span><br><span class="line">    [<span class="built_in">string</span>]<span class="variable">$Path</span></span><br><span class="line"></span><br><span class="line">    [<span class="type">DscProperty</span>(<span class="type">Mandatory</span>)]</span><br><span class="line">    [<span class="built_in">string</span>]<span class="variable">$SourcePath</span></span><br><span class="line"></span><br><span class="line">    [<span class="type">DscProperty</span>(<span class="type">Mandatory</span>)]</span><br><span class="line">    [<span class="built_in">string</span>] <span class="variable">$Ensure</span></span><br><span class="line"></span><br><span class="line">    <span class="function">[<span class="built_in">bool</span>] <span class="title">Test</span></span>() &#123; <span class="keyword">return</span> <span class="variable">$false</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">[<span class="type">FileResource</span>] <span class="title">Get</span></span>() &#123; <span class="keyword">return</span> <span class="variable">$null</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">[<span class="built_in">void</span>] <span class="title">Set</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">New-Item</span> <span class="literal">-Force</span> <span class="literal">-ItemType</span> File <span class="keyword">$this</span>.Path <span class="comment"># &lt;---</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Running the test now should, satisfy the assert condition. But depending on how fast you were to run the test, you did or did not get the same failure message as before. But if you keep running the tests it will fix itself and the test will become GREEN. So there must be some kind of timeout&#x2F;threshold after which the module is reloaded… Uff again.</p>
<p>This does not look like a feasible path to test our DSC resources.</p>
<h3 id="Giving-up"><a href="#Giving-up" class="headerlink" title="Giving up"></a>Giving up</h3><p>Giving up on actually running the resource I found there is this new cmdlet called <code>Invoke-DscResource</code> which does exactly what we need, it let’s us call the Set, Get and Test methods of the resource. But unfortunately I can’t get it to work with class based DSC resources. I always get “resource not found” exception.</p>
<p>Another option would be to simply import the class, instantiate it and call the methods without using the <code>Invoke-DscResource</code> cmdlet. But for some reason that does not work also. Unless the class is defined in the same file (not even in a script block) I can’t instantiate it. All of this fails:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> <span class="string">&quot;C:\Users\nohwnd\Documents\WindowsPowerShell\Modules\MyDscResource\MyDscResource.psd1&quot;</span></span><br><span class="line">[<span class="type">FileResource</span>]::new()</span><br><span class="line"></span><br><span class="line"><span class="variable">$sb</span> = [<span class="type">scriptblock</span>]::Create( <span class="string">&quot;class c &#123;&#125;&quot;</span>)</span><br><span class="line">&amp;<span class="variable">$sb</span></span><br><span class="line"></span><br><span class="line">[<span class="type">c</span>]::new()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="built_in">Get-Content</span> <span class="string">&quot;C:\Users\nohwnd\Documents\WindowsPowerShell\Modules\MyDscResource\MyDscResource.psm1&quot;</span> | <span class="built_in">Out-String</span></span><br><span class="line"><span class="variable">$sb</span> = [<span class="type">scriptblock</span>]::Create( <span class="variable">$code</span> )</span><br><span class="line">&amp;<span class="variable">$sb</span></span><br><span class="line"></span><br><span class="line">[<span class="type">FileResource</span>]::new()</span><br><span class="line"></span><br><span class="line"><span class="comment">#remember the old days? https://johanleino.wordpress.com/2013/09/25/pester-how-to-unit-test-your-powershell-modules/</span></span><br><span class="line"><span class="variable">$code</span> = <span class="built_in">Get-Content</span> <span class="string">&quot;C:\Users\nohwnd\Documents\WindowsPowerShell\Modules\MyDscResource\MyDscResource.psm1&quot;</span> | <span class="built_in">Out-String</span></span><br><span class="line"><span class="built_in">Invoke-Expression</span> <span class="variable">$code</span></span><br><span class="line">[<span class="type">FileResource</span>]::new()</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Unable to find type [FileResource]. Make sure that the assembly that contains this type is loaded.</span><br><span class="line">At line:2 char:1</span><br><span class="line">+ [FileResource]::new()</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (FileResource:TypeName) [], RuntimeException</span><br><span class="line">    + FullyQualifiedErrorId : TypeNotFound</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Unable to find type [c]. Make sure that the assembly that contains this type is loaded.</span><br><span class="line">At line:5 char:1</span><br><span class="line">+ [c]::new()</span><br><span class="line">+ ~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (c:TypeName) [], RuntimeException</span><br><span class="line">    + FullyQualifiedErrorId : TypeNotFound</span><br><span class="line"></span><br><span class="line">Unable to find type [FileResource]. Make sure that the assembly that contains this type is loaded.</span><br><span class="line">At line:12 char:1</span><br><span class="line">+ [FileResource]::new()</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (FileResource:TypeName) [], RuntimeException</span><br><span class="line">    + FullyQualifiedErrorId : TypeNotFound</span><br><span class="line"></span><br><span class="line">Unable to find type [FileResource]. Make sure that the assembly that contains this type is loaded.</span><br><span class="line">At line:17 char:1</span><br><span class="line">+ [FileResource]::new()</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (FileResource:TypeName) [], RuntimeException</span><br><span class="line">    + FullyQualifiedErrorId : TypeNotFound</span><br></pre></td></tr></table></figure>

<p>So at the moment I don’t know how to test the class based resources, but there is new WMF preview published just few hours ago, so maybe this will change soon.</p>

    </div>
    <div class="article-footer">
        <p>written at</p>
        <time datetime="">
            30 April 2015
        </time>
    </div>
</div>
<footer class="footer">
    <div class="footer-filler"></div>

    <a href="https://twitter.com/nohwnd">twitter</a>&bull;
    <a href="https://github.com/nohwnd">github</a>&bull;
    <a href="https://linkedin.com/in/jares/">linkedin</a>
</footer>
</body>

</html>
